<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√≠nh ƒëi·ªÉm GPA HUST</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* ·∫®n thanh cu·ªôn cho input number nh∆∞ng v·∫´n nh·∫≠p ƒë∆∞·ª£c */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-800 min-h-screen pb-32 relative">

    <div id="app">
        <!-- Header s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        <header class="bg-gradient-to-r from-red-700 to-red-900 text-white shadow-lg sticky top-0 z-20">
            <div class="max-w-6xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h1 class="text-xl font-bold leading-tight flex items-center">
                            <img src="logo.png" alt="HUST Logo" class="h-16 w-auto mr-2">
                            T√≠nh ƒëi·ªÉm HUST
                        </h1>
                        <p class="text-xs text-red-100 opacity-90">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&emsp;C√¥ng c·ª• h·ªó tr·ª£
                            sinh vi√™n B√°ch
                            Khoa</p>
                    </div>

                    <div class="flex items-center gap-3">
                        <!-- Language Toggle -->
                        <button onclick="toggleLanguage()" id="lang-toggle"
                            class="px-3 py-1.5 bg-white/15 hover:bg-white/25 rounded-lg text-xs font-medium transition-all flex items-center gap-1.5 text-white border border-white/20">
                            <span id="lang-flag">üáªüá≥</span>
                            <span id="lang-label">VI</span>
                        </button>

                        <!-- Quick Stats Display -->
                        <div class="text-right hidden sm:block" id="header-stats">
                            <!-- Stats injected by JS -->
                        </div>
                    </div>
                </div>

                <!-- Navigation Tabs -->
                <div class="flex space-x-1 bg-red-900/30 p-1 rounded-lg">
                    <button onclick="switchTab('detail')" id="tab-detail"
                        class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all flex items-center justify-center bg-white text-red-700 shadow-sm">
                        <i data-lucide="book-open" class="w-4 h-4 mr-2"></i> T√≠nh t·ª´ng m√¥n
                    </button>
                    <button onclick="switchTab('cumulative')" id="tab-cumulative"
                        class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all flex items-center justify-center text-red-100 hover:bg-white/10">
                        <i data-lucide="layers" class="w-4 h-4 mr-2"></i> T√≠nh CPA c√°c k·ª≥
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-4 py-6 space-y-6" id="main-content">
            <!-- N·ªôi dung ch√≠nh s·∫Ω ƒë∆∞·ª£c render b·ªüi JS -->
        </main>

        <!-- Footer Summary -->
        <div id="footer-summary"
            class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 z-30 hidden">
            <!-- Footer stats injected by JS -->
        </div>
    </div>

    <script>
        // --- TRANSLATIONS ---
        const i18n = {
            vi: {
                tabDetail: 'T√≠nh t·ª´ng m√¥n', tabCumulative: 'T√≠nh CPA c√°c k·ª≥',
                quickSingle: 'T√≠nh Nhanh (1 M√¥n)', quickList: 'T√≠nh H·ªçc K·ª≥ (Nhi·ªÅu M√¥n)',
                enterScores: 'Nh·∫≠p ƒëi·ªÉm ki·ªÉm tra', ratio: 'T·ª∑ tr·ªçng',
                midterm: 'ƒêi·ªÉm QT', final: 'ƒêi·ªÉm CK',
                expectedResult: 'K·∫øt qu·∫£ d·ª± t√≠nh', enterToSee: 'Nh·∫≠p ƒëi·ªÉm qu√° tr√¨nh v√† cu·ªëi k·ª≥ ƒë·ªÉ xem k·∫øt qu·∫£ ngay l·∫≠p t·ª©c.',
                score10: 'ƒêi·ªÉm h·ªá 10', addSubject: 'Th√™m m√¥n v√†o danh s√°ch',
                subjectName: 'T√™n m√¥n h·ªçc', subjectPh: 'VD: ƒê·∫°i s·ªë',
                credits: 'S·ªë t√≠n ch·ªâ', subjectList: 'Danh s√°ch m√¥n',
                clearAll: 'X√≥a h·∫øt', emptyList: 'Nh·∫≠p ƒëi·ªÉm qu√° tr√¨nh v√† cu·ªëi k·ª≥ ƒë·ªÉ t√≠nh GPA.',
                scale10: 'H·ªá 10', letter: 'Ch·ªØ', scale4: 'H·ªá 4',
                enterSemester: 'Nh·∫≠p ƒëi·ªÉm t·ª´ng k·ª≥',
                semesterInfo: 'Nh·∫≠p GPA (h·ªá 4) v√† T·ªïng s·ªë t√≠n ch·ªâ c·ªßa t·ª´ng k·ª≥ h·ªçc ƒë·ªÉ t√≠nh CPA t√≠ch l≈©y chung.',
                semesterName: 'T√™n k·ª≥ h·ªçc', semesterPh: 'VD: 2023.1',
                semCredits: 'S·ªë TC c·ªßa k·ª≥', semCreditsPh: 'VD: 18',
                gpa4: 'GPA (H·ªá 4)', gpa4Ph: 'VD: 3.25', add: 'Th√™m',
                semesterList: 'Danh s√°ch c√°c k·ª≥', emptySemester: 'Ch∆∞a c√≥ d·ªØ li·ªáu k·ª≥ h·ªçc n√†o.',
                gpaSemester: 'GPA K·ª≥', totalCredits: 'T·ªïng T√≠n Ch·ªâ',
                cpa10: 'CPA (H·ªá 10)', gpaScale4: 'GPA (H·ªá 4)',
                totalAccCredits: 'T·ªïng T√≠n T√≠ch L≈©y', cpaAcc: 'CPA T√≠ch L≈©y (H·ªá 4)',
                gpaExpected: 'GPA D·ª± ki·∫øn', quickCalc: 'T√≠nh Nhanh', checkOne: 'Ki·ªÉm tra 1 m√¥n',
                cpaAcc2: 'CPA T√≠ch l≈©y', semCreditsLabel: 'S·ªë t√≠n ch·ªâ',
                defaultSubject: 'M√¥n', defaultSemester: 'K·ª≥',
                excellent: 'Xu·∫•t s·∫Øc', good: 'Gi·ªèi', fairlyGood: 'Kh√° gi·ªèi', fair: 'Kh√°',
                avgGood: 'Trung b√¨nh kh√°', avg: 'Trung b√¨nh', belowAvg: 'Trung b√¨nh y·∫øu', fail: 'Tr∆∞·ª£t m√¥n',
                failMid: 'ƒêi·ªÉm QT < 3', failFin: 'ƒêi·ªÉm CK < 3', failTotal: 'T·ªïng k·∫øt < 4'
            },
            en: {
                tabDetail: 'Per Subject', tabCumulative: 'Cumulative CPA',
                quickSingle: 'Quick Calc (1 Subject)', quickList: 'Semester (Multiple)',
                enterScores: 'Enter Scores', ratio: 'Weight Ratio',
                midterm: 'Midterm', final: 'Final',
                expectedResult: 'Expected Result', enterToSee: 'Enter midterm and final scores to see results instantly.',
                score10: 'Score (Scale 10)', addSubject: 'Add Subject',
                subjectName: 'Subject Name', subjectPh: 'e.g. Algebra',
                credits: 'Credits', subjectList: 'Subject List',
                clearAll: 'Clear All', emptyList: 'Enter midterm and final scores to calculate GPA.',
                scale10: 'Scale 10', letter: 'Grade', scale4: 'Scale 4',
                enterSemester: 'Enter Semester Data',
                semesterInfo: 'Enter GPA (scale 4) and total credits for each semester to calculate cumulative CPA.',
                semesterName: 'Semester', semesterPh: 'e.g. 2023.1',
                semCredits: 'Credits', semCreditsPh: 'e.g. 18',
                gpa4: 'GPA (Scale 4)', gpa4Ph: 'e.g. 3.25', add: 'Add',
                semesterList: 'Semester List', emptySemester: 'No semester data yet.',
                gpaSemester: 'Sem GPA', totalCredits: 'Total Credits',
                cpa10: 'CPA (Scale 10)', gpaScale4: 'GPA (Scale 4)',
                totalAccCredits: 'Total Acc. Credits', cpaAcc: 'Cumulative CPA (Scale 4)',
                gpaExpected: 'Expected GPA', quickCalc: 'Quick Calc', checkOne: 'Check 1 subject',
                cpaAcc2: 'Cumulative CPA', semCreditsLabel: 'Credits',
                defaultSubject: 'Subject', defaultSemester: 'Semester',
                excellent: 'Excellent', good: 'Good', fairlyGood: 'Fairly Good', fair: 'Fair',
                avgGood: 'Above Average', avg: 'Average', belowAvg: 'Below Average', fail: 'Failed',
                failMid: 'Midterm < 3', failFin: 'Final < 3', failTotal: 'Total < 4'
            }
        };
        function t(key) { return i18n[state.language][key] || key; }

        // --- STATE MANAGEMENT ---
        const state = {
            activeTab: 'detail',
            detailMode: 'list',
            language: 'vi',

            // Data for Single Mode (T√≠nh Nhanh)
            quickSubject: { credits: 3, midterm: '', final: '', ratio: '0.3-0.7' },

            // Data for List Mode (T√≠nh Nhi·ªÅu M√¥n)
            subjects: [],

            // Data for Cumulative Mode (CPA C√°c K·ª≥)
            semesters: []
        };

        // --- UTILS & LOGIC ---

        function getGrade(score, isFailed) {
            if (isFailed) return { letter: 'F', gpa: 0.0, color: 'text-red-600', text: t('fail') };
            if (score >= 9.5) return { letter: 'A+', gpa: 4.0, color: 'text-green-600', text: t('excellent') };
            if (score >= 8.5) return { letter: 'A', gpa: 4.0, color: 'text-green-600', text: t('good') };
            if (score >= 8.0) return { letter: 'B+', gpa: 3.5, color: 'text-blue-600', text: t('fairlyGood') };
            if (score >= 7.0) return { letter: 'B', gpa: 3.0, color: 'text-blue-600', text: t('fair') };
            if (score >= 6.5) return { letter: 'C+', gpa: 2.5, color: 'text-yellow-600', text: t('avgGood') };
            if (score >= 5.5) return { letter: 'C', gpa: 2.0, color: 'text-yellow-600', text: t('avg') };
            if (score >= 5.0) return { letter: 'D+', gpa: 1.5, color: 'text-orange-600', text: t('belowAvg') };
            if (score >= 4.0) return { letter: 'D', gpa: 1.0, color: 'text-orange-600', text: t('belowAvg') };
            return { letter: 'F', gpa: 0.0, color: 'text-red-600', text: t('fail') };
        }

        function calculateSubjectResult(sub) {
            const mid = parseFloat(sub.midterm);
            const fin = parseFloat(sub.final);
            const parts = sub.ratio.split('-');
            const midRatio = parseFloat(parts[0]);
            const finRatio = parseFloat(parts[1]);

            if (isNaN(mid) || isNaN(fin)) return null;

            let score10 = (mid * midRatio) + (fin * finRatio);

            // L√†m tr√≤n 2 ch·ªØ s·ªë th·∫≠p ph√¢n tr∆∞·ªõc ƒë·ªÉ tr√°nh l·ªói floating point
            score10 = Math.round(score10 * 100) / 100;

            // L√†m tr√≤n l√™n n·∫øu ph·∫ßn th·∫≠p ph√¢n >= 0.95 (VD: 3.95 ‚Üí 4, 8.95 ‚Üí 9)
            const decimal = score10 - Math.floor(score10);
            if (decimal >= 0.95) score10 = Math.ceil(score10);

            // Logic ƒëi·ªÉm li·ªát: T·ªïng < 4 HO·∫∂C Qu√° tr√¨nh < 3 HO·∫∂C Cu·ªëi k·ª≥ < 3
            let failReason = '';
            if (mid < 3.0) failReason = t('failMid');
            else if (fin < 3.0) failReason = t('failFin');
            else if (score10 < 4.0) failReason = t('failTotal');

            const isFailed = !!failReason;

            return {
                score10: score10.toFixed(2),
                grade: getGrade(score10, isFailed),
                isFailed,
                failReason
            };
        }

        function getDetailStats() {
            return state.subjects.reduce((acc, curr) => {
                const result = calculateSubjectResult(curr);
                const credits = parseFloat(curr.credits);
                if (result && !isNaN(result.grade.gpa)) {
                    acc.totalCredits += credits;
                    acc.totalWeightedGPA += result.grade.gpa * credits;
                    acc.totalScore10 += parseFloat(result.score10) * credits;
                }
                return acc;
            }, { totalCredits: 0, totalWeightedGPA: 0, totalScore10: 0 });
        }

        function getCumulativeStats() {
            return state.semesters.reduce((acc, curr) => {
                const gpa = parseFloat(curr.gpa);
                const cred = parseFloat(curr.credits);
                if (!isNaN(gpa) && !isNaN(cred)) {
                    acc.totalCredits += cred;
                    acc.totalWeightedScore += gpa * cred;
                }
                return acc;
            }, { totalCredits: 0, totalWeightedScore: 0 });
        }

        // --- RENDER FUNCTIONS ---

        function renderHeaderStats() {
            const container = document.getElementById('header-stats');
            let html = '';

            if (state.activeTab === 'detail') {
                if (state.detailMode === 'list') {
                    const stats = getDetailStats();
                    const gpa4 = stats.totalCredits ? (stats.totalWeightedGPA / stats.totalCredits).toFixed(2) : '0.00';
                    html = `
                        <div class="text-2xl font-bold">${gpa4} <span class="text-sm font-normal text-red-200">/ 4.0</span></div>
                        <div class="text-xs text-red-200">${t('gpaExpected')}</div>
                    `;
                } else {
                    html = `
                        <div class="text-xl font-bold text-red-100">${t('quickCalc')}</div>
                        <div class="text-xs text-red-200">${t('checkOne')}</div>
                    `;
                }
            } else {
                const stats = getCumulativeStats();
                const cpa = stats.totalCredits ? (stats.totalWeightedScore / stats.totalCredits).toFixed(2) : '0.00';
                html = `
                    <div class="text-2xl font-bold">${cpa} <span class="text-sm font-normal text-red-200">/ 4.0</span></div>
                    <div class="text-xs text-red-200">${t('cpaAcc2')}</div>
                `;
            }
            container.innerHTML = html;
        }

        function renderFooter() {
            const container = document.getElementById('footer-summary');
            const shouldShow = state.activeTab === 'cumulative' || (state.activeTab === 'detail' && state.detailMode === 'list');

            if (!shouldShow) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            let html = '<div class="max-w-6xl mx-auto flex justify-between items-center">';

            if (state.activeTab === 'detail') {
                const stats = getDetailStats();
                const gpa4 = stats.totalCredits ? (stats.totalWeightedGPA / stats.totalCredits).toFixed(2) : '0.00';
                const cpa10 = stats.totalCredits ? (stats.totalScore10 / stats.totalCredits).toFixed(2) : '0.00';

                html += `
                    <div>
                        <div class="text-xs text-gray-500 font-medium uppercase tracking-wider">${t('totalCredits')}</div>
                        <div class="text-xl font-bold text-gray-800">${stats.totalCredits}</div>
                    </div>
                    <div class="flex gap-6 sm:gap-12">
                        <div class="text-right">
                            <div class="text-xs text-gray-500 font-medium uppercase tracking-wider">${t('cpa10')}</div>
                            <div class="text-xl font-bold text-gray-700">${cpa10}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500 font-medium uppercase tracking-wider">${t('gpaScale4')}</div>
                            <div class="text-2xl font-black text-red-700">${gpa4}</div>
                        </div>
                    </div>
                        </div>
                    </div>
                `;
            } else {
                const stats = getCumulativeStats();
                const cpa = stats.totalCredits ? (stats.totalWeightedScore / stats.totalCredits).toFixed(2) : '0.00';

                html += `
                    <div>
                        <div class="text-xs text-gray-500 font-medium uppercase tracking-wider">${t('totalAccCredits')}</div>
                        <div class="text-xl font-bold text-gray-800">${stats.totalCredits}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500 font-medium uppercase tracking-wider">${t('cpaAcc')}</div>
                        <div class="text-2xl font-black text-red-700">${cpa}</div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderDetailView() {
            const main = document.getElementById('main-content');

            // Sub-navigation buttons
            const btnSingleClass = state.detailMode === 'single' ? 'bg-white text-red-600 shadow-sm' : 'text-gray-500 hover:text-gray-700';
            const btnListClass = state.detailMode === 'list' ? 'bg-white text-red-600 shadow-sm' : 'text-gray-500 hover:text-gray-700';

            let html = `
                <div class="flex justify-center mb-6">
                    <div class="inline-flex bg-gray-200 p-1 rounded-full relative">
                        <button onclick="switchDetailMode('single')" class="relative z-10 px-6 py-2 rounded-full text-sm font-semibold transition-all flex items-center ${btnSingleClass}">
                            <i data-lucide="zap" class="w-4 h-4 mr-1.5"></i> ${t('quickSingle')}
                        </button>
                        <button onclick="switchDetailMode('list')" class="relative z-10 px-6 py-2 rounded-full text-sm font-semibold transition-all flex items-center ${btnListClass}">
                            <i data-lucide="list" class="w-4 h-4 mr-1.5"></i> ${t('quickList')}
                        </button>
                    </div>
                </div>
            `;

            if (state.detailMode === 'single') {
                html += renderSingleMode();
            } else {
                html += renderListMode();
            }

            html += renderCreditFooter();
            main.innerHTML = html;

            // Re-bind listeners for Single Mode inputs
            if (state.detailMode === 'single') bindSingleModeListeners();
        }

        function renderSingleMode() {
            const { quickSubject } = state;

            return `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="zap" class="w-5 h-5 mr-2 text-yellow-500"></i> ${t('enterScores')}
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">${t('ratio')}</label>
                            <select id="q-ratio" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm">
                                <option value="0.3-0.7" ${quickSubject.ratio === '0.3-0.7' ? 'selected' : ''}>30% - 70%</option>
                                <option value="0.4-0.6" ${quickSubject.ratio === '0.4-0.6' ? 'selected' : ''}>40% - 60%</option>
                                <option value="0.5-0.5" ${quickSubject.ratio === '0.5-0.5' ? 'selected' : ''}>50% - 50%</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">${t('midterm')}</label>
                                <input type="number" id="q-midterm" step="0.1" min="0" max="10" placeholder="0-10" value="${quickSubject.midterm}"
                                    class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm font-bold text-gray-700">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">${t('final')}</label>
                                <input type="number" id="q-final" step="0.1" min="0" max="10" placeholder="0-10" value="${quickSubject.final}"
                                    class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm font-bold text-gray-700">
                            </div>
                        </div>
                    </div>
                </section>

                <section id="quick-result-card" class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 flex flex-col justify-center">
                    ${renderQuickResultCard()}
                </section>
            </div>
            `;
        }

        function renderQuickResultCard() {
            const result = calculateSubjectResult(state.quickSubject);

            if (result) {
                return `
                    <div class="text-center">
                        <h3 class="text-gray-500 text-sm uppercase tracking-wider mb-2">${t('expectedResult')}</h3>
                        
                        <div class="inline-flex flex-col items-center justify-center w-32 h-32 rounded-full border-4 mb-4 ${result.isFailed ? 'border-red-100 bg-red-50' : 'border-green-100 bg-green-50'}">
                            <span class="text-4xl font-black ${result.grade.color}">${result.grade.letter}</span>
                            <span class="text-xs text-gray-500 font-medium mt-1">GPA: ${result.grade.gpa}</span>
                        </div>

                        <div class="space-y-2">
                            <div class="text-xl font-bold ${result.isFailed ? 'text-red-600' : 'text-green-600'}">
                                ${result.grade.text}
                            </div>
                            ${result.isFailed ? `
                                <div class="inline-flex items-center px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                    <i data-lucide="alert-circle" class="w-3 h-3 mr-1"></i> ${result.failReason}
                                </div>
                            ` : `
                                <div class="text-gray-500 text-sm">${t('score10')}: <span class="font-bold text-gray-800">${result.score10}</span></div>
                            `}
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="text-center text-gray-400 py-8">
                        <i data-lucide="zap" class="w-12 h-12 mx-auto mb-2 opacity-20"></i>
                        <p>${t('enterToSee')}</p>
                    </div>
                `;
            }
        }

        function renderListMode() {
            let html = `
                <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2 text-red-600"></i> ${t('addSubject')}
                    </h2>
                    <form onsubmit="handleAddSubject(event)" class="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div class="md:col-span-3">
                            <label class="block text-xs font-medium text-gray-500 mb-1">${t('subjectName')}</label>
                            <input type="text" name="name" placeholder="${t('subjectPh')}" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 transition-all outline-none text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">${t('credits')}</label>
                            <select name="credits" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm">
                                <option value="1">1 TC</option>
                                <option value="2">2 TC</option>
                                <option value="3" selected>3 TC</option>
                                <option value="4">4 TC</option>
                                <option value="5">5 TC</option>
                                <option value="6">6 TC</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">${t('ratio')}</label>
                            <select name="ratio" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm">
                                <option value="0.3-0.7">30% - 70%</option>
                                <option value="0.4-0.6">40% - 60%</option>
                                <option value="0.5-0.5">50% - 50%</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">${t('midterm')}</label>
                            <input type="number" name="midterm" step="0.1" min="0" max="10" required placeholder="0-10" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">${t('final')}</label>
                            <input type="number" name="final" step="0.1" min="0" max="10" required placeholder="0-10" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm">
                        </div>
                        <div class="md:col-span-1 flex items-end">
                            <button type="submit" class="w-full p-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex items-center justify-center">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </form>
                </section>

                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-700 flex items-center">
                            <i data-lucide="book-open" class="w-5 h-5 mr-2 text-red-600"></i> ${t('subjectList')}
                        </h2>
                        ${state.subjects.length > 0 ? `
                            <button onclick="clearSubjects()" class="text-xs text-red-500 hover:text-red-700 flex items-center bg-red-50 px-3 py-1.5 rounded-full">
                                <i data-lucide="rotate-ccw" class="w-3 h-3 mr-1"></i> ${t('clearAll')}
                            </button>
                        ` : ''}
                    </div>

                    ${state.subjects.length === 0 ? `
                        <div class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                            <div class="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="graduation-cap" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <p class="text-gray-500">${t('emptyList')}</p>
                        </div>
                    ` : renderSubjectsList()}
                </section>
            `;
            return html;
        }

        function renderSubjectsList() {
            return `
                <div class="grid gap-4">
                    ${state.subjects.map(sub => {
                const result = calculateSubjectResult(sub);
                if (!result) return '';
                return `
                            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${result.isFailed ? 'border-l-red-500' : 'border-l-green-500'} flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800 text-lg">${sub.name}</h3>
                                    <div class="flex flex-wrap gap-2 mt-1 text-sm text-gray-500">
                                        <span class="bg-gray-100 px-2 py-0.5 rounded text-xs">${sub.credits} TC</span>
                                        <span class="bg-gray-100 px-2 py-0.5 rounded text-xs">${sub.ratio.replace('-', '/')}</span>
                                        <span>QT: <b>${sub.midterm}</b> - CK: <b>${sub.final}</b></span>
                                    </div>
                                    ${result.isFailed ? `
                                        <div class="mt-2 text-xs font-semibold text-red-600 flex items-center bg-red-50 w-fit px-2 py-1 rounded">
                                            <i data-lucide="alert-circle" class="w-3 h-3 mr-1"></i> ${result.failReason}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="flex items-center gap-4 justify-between sm:justify-end border-t sm:border-t-0 pt-3 sm:pt-0">
                                    <div class="text-center min-w-[50px]"><div class="text-xs text-gray-400">${t('scale10')}</div><div class="font-bold text-gray-700">${result.score10}</div></div>
                                    <div class="text-center min-w-[50px]"><div class="text-xs text-gray-400">${t('letter')}</div><div class="font-bold text-xl ${result.grade.color}">${result.grade.letter}</div></div>
                                    <div class="text-center min-w-[50px]"><div class="text-xs text-gray-400">${t('scale4')}</div><div class="font-bold text-gray-700">${result.grade.gpa}</div></div>
                                    <button onclick="deleteSubject(${sub.id})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function renderCumulativeView() {
            const main = document.getElementById('main-content');

            let html = `
                <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-red-600"></i> ${t('enterSemester')}
                    </h2>
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-4 text-sm text-blue-800 flex items-start">
                        <i data-lucide="alert-circle" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                        ${t('semesterInfo')}
                    </div>
                    <form onsubmit="handleAddSemester(event)" class="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div class="md:col-span-4">
                            <label class="block text-xs font-medium text-gray-500 mb-1">${t('semesterName')}</label>
                            <input type="text" name="name" placeholder="${t('semesterPh')}" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-xs font-medium text-gray-500 mb-1">${t('semCredits')}</label>
                            <input type="number" name="credits" step="1" min="1" required placeholder="${t('semCreditsPh')}" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-xs font-medium text-gray-500 mb-1">${t('gpa4')}</label>
                            <input type="number" name="gpa" step="0.01" min="0" max="4" required placeholder="${t('gpa4Ph')}" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm">
                        </div>
                        <div class="md:col-span-2 flex items-end">
                            <button type="submit" class="w-full p-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex items-center justify-center">
                                <i data-lucide="plus" class="w-5 h-5"></i> ${t('add')}
                            </button>
                        </div>
                    </form>
                </section>

                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-700 flex items-center">
                            <i data-lucide="layers" class="w-5 h-5 mr-2 text-red-600"></i> ${t('semesterList')}
                        </h2>
                        ${state.semesters.length > 0 ? `
                            <button onclick="clearSemesters()" class="text-xs text-red-500 hover:text-red-700 flex items-center bg-red-50 px-3 py-1.5 rounded-full">
                                <i data-lucide="rotate-ccw" class="w-3 h-3 mr-1"></i> X√≥a h·∫øt
                            </button>
                        ` : ''}
                    </div>

                    ${state.semesters.length === 0 ? `
                        <div class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                            <div class="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="bar-chart-3" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <p class="text-gray-500">${t('emptySemester')}</p>
                        </div>
                    ` : renderSemestersList()}
                </section>
            `;

            html += renderCreditFooter();
            main.innerHTML = html;
        }

        function renderSemestersList() {
            return `
                <div class="grid gap-3">
                    ${state.semesters.map(sem => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-gray-800">${sem.name}</h3>
                                <div class="text-sm text-gray-500 mt-1">
                                    ${t('semCreditsLabel')}: <span class="font-medium text-gray-700">${sem.credits}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-6">
                                <div class="text-right">
                                    <div class="text-xs text-gray-400 uppercase">${t('gpaSemester')}</div>
                                    <div class="text-xl font-bold text-blue-600">${parseFloat(sem.gpa).toFixed(2)}</div>
                                </div>
                                <button onclick="deleteSemester(${sem.id})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderCreditFooter() {
            const year = new Date().getFullYear();
            return `
                <footer class="pt-8 text-center pb-20">
                    <p class="text-sm text-gray-400 flex items-center justify-center">
                        &copy; ${year} Developed by <span class="font-bold text-red-700 ml-1">Soumek Xaynguyen</span>
                    </p>
                </footer>
            `;
        }

        function renderApp() {
            // Render Header Stats
            renderHeaderStats();

            // Render Main Content
            if (state.activeTab === 'detail') {
                renderDetailView();
            } else {
                renderCumulativeView();
            }

            // Render Footer
            renderFooter();

            // Init Icons
            lucide.createIcons();

            // Update Tab Styles + Labels
            const tabDetail = document.getElementById('tab-detail');
            const tabCumulative = document.getElementById('tab-cumulative');
            tabDetail.innerHTML = `<i data-lucide="book-open" class="w-4 h-4 mr-2"></i> ${t('tabDetail')}`;
            tabCumulative.innerHTML = `<i data-lucide="layers" class="w-4 h-4 mr-2"></i> ${t('tabCumulative')}`;

            if (state.activeTab === 'detail') {
                tabDetail.className = "flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all flex items-center justify-center bg-white text-red-700 shadow-sm";
                tabCumulative.className = "flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all flex items-center justify-center text-red-100 hover:bg-white/10";
            } else {
                tabDetail.className = "flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all flex items-center justify-center text-red-100 hover:bg-white/10";
                tabCumulative.className = "flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all flex items-center justify-center bg-white text-red-700 shadow-sm";
            }

            // Re-init icons after tab label update
            lucide.createIcons();
        }

        // --- EVENT HANDLERS ---

        function switchTab(tab) {
            state.activeTab = tab;
            renderApp();
        }

        function toggleLanguage() {
            state.language = state.language === 'vi' ? 'en' : 'vi';
            document.getElementById('lang-flag').textContent = state.language === 'vi' ? 'üáªüá≥' : 'üá¨üáß';
            document.getElementById('lang-label').textContent = state.language === 'vi' ? 'VI' : 'EN';
            renderApp();
        }

        function switchDetailMode(mode) {
            state.detailMode = mode;
            renderApp();
        }

        // Single Mode Events
        function bindSingleModeListeners() {
            document.getElementById('q-ratio').addEventListener('change', (e) => updateQuickSubject('ratio', e.target.value));
            document.getElementById('q-midterm').addEventListener('input', (e) => updateQuickSubject('midterm', e.target.value));
            document.getElementById('q-final').addEventListener('input', (e) => updateQuickSubject('final', e.target.value));
        }

        function updateQuickSubject(key, value) {
            // Gi·ªõi h·∫°n ƒëi·ªÉm nh·∫≠p t·ªëi ƒëa l√† 10, t·ªëi thi·ªÉu l√† 0
            if (key === 'midterm' || key === 'final') {
                let num = parseFloat(value);
                if (!isNaN(num)) {
                    if (num > 10) { num = 10; document.getElementById(key === 'midterm' ? 'q-midterm' : 'q-final').value = 10; }
                    if (num < 0) { num = 0; document.getElementById(key === 'midterm' ? 'q-midterm' : 'q-final').value = 0; }
                    value = num.toString();
                }
            }
            state.quickSubject[key] = value;
            // Only re-render the card, not the inputs to avoid focus loss
            document.getElementById('quick-result-card').innerHTML = renderQuickResultCard();
            lucide.createIcons();
        }

        // List Mode Events
        function handleAddSubject(e) {
            e.preventDefault();
            const form = e.target;
            const newSub = {
                id: Date.now(),
                name: form.name.value || `${t('defaultSubject')} ${state.subjects.length + 1}`,
                credits: parseInt(form.credits.value),
                ratio: form.ratio.value,
                midterm: form.midterm.value,
                final: form.final.value
            };

            state.subjects.push(newSub);
            form.reset();
            form.credits.value = "3"; // Default reset
            form.ratio.value = "0.3-0.7"; // Default reset
            renderApp();
        }

        function deleteSubject(id) {
            state.subjects = state.subjects.filter(s => s.id !== id);
            renderApp();
        }

        function clearSubjects() {
            state.subjects = [];
            renderApp();
        }

        // Cumulative Mode Events
        function handleAddSemester(e) {
            e.preventDefault();
            const form = e.target;
            const newSem = {
                id: Date.now(),
                name: form.name.value || `${t('defaultSemester')} ${state.semesters.length + 1}`,
                credits: form.credits.value,
                gpa: form.gpa.value
            };

            state.semesters.push(newSem);
            form.reset();
            renderApp();
        }

        function deleteSemester(id) {
            state.semesters = state.semesters.filter(s => s.id !== id);
            renderApp();
        }

        function clearSemesters() {
            state.semesters = [];
            renderApp();
        }

        // Initial Render
        renderApp();

    </script>
</body>

</html>